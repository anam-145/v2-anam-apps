<!DOCTYPE html>
<html>
<head>
  <title>Stellar2 Mnemonic Flow Test</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .test { margin: 20px; padding: 20px; border: 1px solid #ccc; }
    .success { color: green; }
    .error { color: red; }
    .info { color: blue; }
  </style>
</head>
<body>
  <h1>Stellar2 Mnemonic Flow Test</h1>

  <div class="test">
    <h2>Test Mnemonic Flow</h2>
    <button onclick="testMnemonicFlow()">Test Mnemonic Flow</button>
    <div id="result"></div>
  </div>

  <div class="test">
    <h2>Test Adapter</h2>
    <button onclick="testAdapter()">Test Stellar Adapter</button>
    <div id="adapter-result"></div>
  </div>

  <script>
    function testMnemonicFlow() {
      const result = document.getElementById('result');
      const iframe = document.createElement('iframe');
      iframe.src = 'pages/index/index.html';
      iframe.style.width = '100%';
      iframe.style.height = '600px';
      iframe.style.border = '1px solid #ddd';

      result.innerHTML = '<p class="info">Loading Stellar wallet page...</p>';
      result.appendChild(iframe);

      iframe.onload = () => {
        setTimeout(() => {
          const checks = [];

          // Check if mnemonic flow is available
          if (iframe.contentWindow.mnemonicFlow) {
            checks.push('✅ MnemonicFlow manager loaded');
          } else {
            checks.push('❌ MnemonicFlow manager not loaded');
          }

          // Check if startMnemonicFlow is defined
          if (iframe.contentWindow.startMnemonicFlow) {
            checks.push('✅ startMnemonicFlow function available');
          } else {
            checks.push('❌ startMnemonicFlow function not available');
          }

          // Check if adapter is available
          if (iframe.contentWindow.getAdapter) {
            checks.push('✅ Stellar adapter available');
            const adapter = iframe.contentWindow.getAdapter();
            if (adapter && adapter.isInitialized) {
              checks.push('✅ Stellar adapter initialized');
            } else {
              checks.push('⚠️ Stellar adapter not yet initialized');
            }
          } else {
            checks.push('❌ getAdapter function not available');
          }

          // Check if callback is defined
          if (iframe.contentWindow.onMnemonicFlowComplete) {
            checks.push('✅ onMnemonicFlowComplete callback defined');
          } else {
            checks.push('❌ onMnemonicFlowComplete callback not defined');
          }

          const summary = document.createElement('div');
          summary.innerHTML = '<h3>Test Results:</h3>' + checks.join('<br>');
          result.insertBefore(summary, iframe);

          // If everything is loaded, show button to trigger flow
          if (iframe.contentWindow.startMnemonicFlow && iframe.contentWindow.getAdapter) {
            const triggerBtn = document.createElement('button');
            triggerBtn.textContent = 'Trigger Mnemonic Flow';
            triggerBtn.onclick = () => {
              iframe.contentWindow.startMnemonicFlow();
              result.insertAdjacentHTML('beforeend', '<p class="info">Mnemonic flow started in iframe...</p>');
            };
            result.insertBefore(triggerBtn, iframe);
          }
        }, 1500);
      };
    }

    async function testAdapter() {
      const result = document.getElementById('adapter-result');
      result.innerHTML = '<p class="info">Testing Stellar adapter directly...</p>';

      // Load scripts
      const scripts = [
        '../../assets/stellar-bundle.iife.js',
        '../../utils/config.js',
        '../../utils/storage.js',
        '../../utils/helpers.js',
        '../../app.js'
      ];

      for (const src of scripts) {
        await loadScript(src);
      }

      setTimeout(() => {
        const checks = [];

        if (window.stellarSDK) {
          checks.push('✅ Stellar SDK loaded');
        } else {
          checks.push('❌ Stellar SDK not loaded');
        }

        if (window.getAdapter) {
          checks.push('✅ getAdapter function available');

          const adapter = window.getAdapter();
          if (adapter) {
            checks.push('✅ Adapter instance created');

            // Test wallet generation
            adapter.generateWallet().then(wallet => {
              checks.push('✅ Wallet generated successfully');
              checks.push(`   Address: ${wallet.address.substring(0, 20)}...`);
              checks.push(`   Has mnemonic: ${!!wallet.mnemonic}`);
              result.innerHTML = checks.join('<br>');
            }).catch(error => {
              checks.push(`❌ Wallet generation failed: ${error.message}`);
              result.innerHTML = checks.join('<br>');
            });
          } else {
            checks.push('❌ Failed to create adapter instance');
          }
        } else {
          checks.push('❌ getAdapter function not available');
        }

        result.innerHTML = checks.join('<br>');
      }, 1000);
    }

    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
  </script>
</body>
</html>