<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <title>Cosmos 지갑 복구 테스트</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .test-section {
                margin: 20px 0;
                padding: 20px;
                border: 1px solid #ccc;
                border-radius: 5px;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
            }
            button:hover {
                background: #0056b3;
            }
            input,
            textarea {
                width: 100%;
                padding: 10px;
                margin: 5px 0;
                border: 1px solid #ccc;
                border-radius: 5px;
            }
            .result {
                margin: 10px 0;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 5px;
            }
            .error {
                background: #f8d7da;
                color: #721c24;
            }
            .success {
                background: #d4edda;
                color: #155724;
            }
        </style>
    </head>
    <body>
        <h1>Cosmos 지갑 복구 테스트</h1>

        <div class="test-section">
            <h2>1. 지갑 초기화 테스트</h2>
            <button onclick="testInitialization()">
                지갑 초기화
            </button>
            <div id="init-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. 새 지갑 생성 테스트</h2>
            <button onclick="testCreateWallet()">
                새 지갑 생성
            </button>
            <div id="create-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. 지갑 복구 테스트</h2>
            <label for="mnemonic-input">니모닉 입력:</label>
            <textarea
                id="mnemonic-input"
                rows="4"
                placeholder="12개 또는 24개 단어를 공백으로 구분하여 입력하세요"
            ></textarea>
            <button onclick="testRestoreWallet()">
                지갑 복구
            </button>
            <div id="restore-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. CosmosJS 상태 확인</h2>
            <button onclick="checkCosmosJS()">
                CosmosJS 상태 확인
            </button>
            <div id="cosmosjs-result" class="result"></div>
        </div>

        <div class="test-section">
            <h2>5. Store 상태 관리 테스트</h2>
            <button onclick="testStoreState()">
                Store 상태 확인
            </button>
            <button onclick="testStoreSubscription()">
                Store 구독 테스트
            </button>
            <button onclick="testStoreEvents()">
                Store 이벤트 테스트
            </button>
            <div id="store-result" class="result"></div>
        </div>

        <!-- Cosmos SDK 번들러 로드 -->
        <script src="assets/libs/cosmos-bundle.iife.js"></script>
        <script src="app.js"></script>
        <script src="assets/libs/config-loader.js"></script>

        <script>
            function showResult(
                elementId,
                message,
                isError = false
            ) {
                const element =
                    document.getElementById(elementId);
                element.textContent = message;
                element.className = `result ${
                    isError ? 'error' : 'success'
                }`;
            }

            async function testInitialization() {
                try {
                    console.log('지갑 초기화 시작...');
                    await window.cosmosWallet.initialize();
                    showResult(
                        'init-result',
                        '지갑 초기화 성공!'
                    );
                } catch (error) {
                    console.error('초기화 실패:', error);
                    showResult(
                        'init-result',
                        `초기화 실패: ${error.message}`,
                        true
                    );
                }
            }

            async function testCreateWallet() {
                try {
                    console.log('새 지갑 생성 시작...');
                    const result =
                        await window.cosmosWallet.createNewWallet();
                    if (result.success) {
                        showResult(
                            'create-result',
                            `지갑 생성 성공!\n주소: ${result.address}\n니모닉: ${result.mnemonic}`
                        );
                    } else {
                        showResult(
                            'create-result',
                            `지갑 생성 실패: ${result.error}`,
                            true
                        );
                    }
                } catch (error) {
                    console.error('지갑 생성 실패:', error);
                    showResult(
                        'create-result',
                        `지갑 생성 실패: ${error.message}`,
                        true
                    );
                }
            }

            async function testRestoreWallet() {
                try {
                    const mnemonic = document
                        .getElementById('mnemonic-input')
                        .value.trim();
                    if (!mnemonic) {
                        showResult(
                            'restore-result',
                            '니모닉을 입력해주세요.',
                            true
                        );
                        return;
                    }

                    console.log('지갑 복구 시작...');
                    const result =
                        await window.cosmosWallet.restoreWallet(
                            mnemonic
                        );
                    if (result.success) {
                        showResult(
                            'restore-result',
                            `지갑 복구 성공!\n주소: ${result.address}`
                        );
                    } else {
                        showResult(
                            'restore-result',
                            `지갑 복구 실패: ${result.error}`,
                            true
                        );
                    }
                } catch (error) {
                    console.error('지갑 복구 실패:', error);
                    showResult(
                        'restore-result',
                        `지갑 복구 실패: ${error.message}`,
                        true
                    );
                }
            }

            function checkCosmosJS() {
                const status = {
                    CosmosJS:
                        typeof CosmosJS !== 'undefined',
                    cosmosWallet:
                        typeof window.cosmosWallet !==
                        'undefined',
                    isInitialized:
                        window.cosmosWallet
                            ?.isInitialized || false,
                    functions: {},
                };

                if (typeof CosmosJS !== 'undefined') {
                    status.functions = {
                        generateMnemonic:
                            typeof CosmosJS.generateMnemonic ===
                            'function',
                        validateMnemonic:
                            typeof CosmosJS.validateMnemonic ===
                            'function',
                        createHdWalletFromMnemonic:
                            typeof CosmosJS.createHdWalletFromMnemonic ===
                            'function',
                        getWalletAddress:
                            typeof CosmosJS.getWalletAddress ===
                            'function',
                        initializeConfig:
                            typeof CosmosJS.initializeConfig ===
                            'function',
                    };
                }

                showResult(
                    'cosmosjs-result',
                    `CosmosJS 상태:\n${JSON.stringify(
                        status,
                        null,
                        2
                    )}`
                );
            }

            // Store 상태 확인 테스트
            function testStoreState() {
                console.log('testStoreState 호출됨');
                console.log(
                    'window.cosmosStore:',
                    window.cosmosStore
                );

                if (!window.cosmosStore) {
                    console.error('Store가 로드되지 않음');
                    showResult(
                        'store-result',
                        'Store가 로드되지 않았습니다. 콘솔을 확인하세요.',
                        true
                    );
                    return;
                }

                try {
                    const state =
                        window.cosmosStore.getState();
                    console.log(
                        'Store 상태 조회 성공:',
                        state
                    );
                    showResult(
                        'store-result',
                        `Store 상태:\n${JSON.stringify(
                            state,
                            null,
                            2
                        )}`
                    );
                } catch (error) {
                    console.error(
                        'Store 상태 조회 실패:',
                        error
                    );
                    showResult(
                        'store-result',
                        `Store 상태 조회 실패: ${error.message}`,
                        true
                    );
                }
            }

            // Store 구독 테스트
            function testStoreSubscription() {
                if (!window.cosmosStore) {
                    showResult(
                        'store-result',
                        'Store가 로드되지 않았습니다.',
                        true
                    );
                    return;
                }

                // 구독 함수
                const unsubscribe =
                    window.cosmosStore.subscribe(
                        (newState, oldState, eventType) => {
                            console.log(
                                'Store 구독 테스트 - 상태 변화:',
                                {
                                    eventType,
                                    newState: {
                                        isLoading:
                                            newState.isLoading,
                                        error: newState.error,
                                        isInitialized:
                                            newState.isInitialized,
                                    },
                                }
                            );

                            showResult(
                                'store-result',
                                `Store 구독 테스트 - 이벤트: ${eventType}\n새 상태: ${JSON.stringify(
                                    {
                                        isLoading:
                                            newState.isLoading,
                                        error: newState.error,
                                        isInitialized:
                                            newState.isInitialized,
                                    },
                                    null,
                                    2
                                )}`
                            );
                        }
                    );

                // 3초 후 구독 해제
                setTimeout(() => {
                    unsubscribe();
                    showResult(
                        'store-result',
                        'Store 구독 테스트 완료 (구독 해제됨)'
                    );
                }, 3000);

                showResult(
                    'store-result',
                    'Store 구독 테스트 시작 (3초간 구독)'
                );
            }

            // Store 이벤트 테스트
            function testStoreEvents() {
                if (!window.cosmosStore) {
                    showResult(
                        'store-result',
                        'Store가 로드되지 않았습니다.',
                        true
                    );
                    return;
                }

                // 다양한 이벤트 테스트
                window.cosmosStore.setLoading(true);
                setTimeout(() => {
                    window.cosmosStore.setLoading(false);
                }, 1000);

                setTimeout(() => {
                    window.cosmosStore.setError(
                        '테스트 에러 메시지'
                    );
                }, 2000);

                setTimeout(() => {
                    window.cosmosStore.setError(null);
                }, 3000);

                showResult(
                    'store-result',
                    'Store 이벤트 테스트 시작 (로딩 → 에러 → 정리)'
                );
            }

            // Store 초기화 확인 함수
            function checkStoreInitialization() {
                console.log('=== Store 초기화 확인 ===');
                console.log(
                    'window.cosmosStore:',
                    window.cosmosStore
                );
                console.log(
                    'window.cosmosWallet:',
                    window.cosmosWallet
                );
                console.log(
                    'window.WalletUtils:',
                    window.WalletUtils
                );

                let allLoaded = true;

                if (!window.cosmosStore) {
                    console.error(
                        '❌ cosmosStore가 로드되지 않음'
                    );
                    allLoaded = false;
                } else {
                    console.log('✅ cosmosStore 로드됨');
                    try {
                        const state =
                            window.cosmosStore.getState();
                        console.log('Store 상태:', state);
                    } catch (error) {
                        console.error(
                            'Store 상태 조회 실패:',
                            error
                        );
                        allLoaded = false;
                    }
                }

                if (!window.cosmosWallet) {
                    console.error(
                        '❌ cosmosWallet이 로드되지 않음'
                    );
                    allLoaded = false;
                } else {
                    console.log('✅ cosmosWallet 로드됨');
                    console.log(
                        'cosmosWallet 메서드들:',
                        Object.getOwnPropertyNames(
                            Object.getPrototypeOf(
                                window.cosmosWallet
                            )
                        )
                    );
                }

                if (!window.WalletUtils) {
                    console.error(
                        '❌ WalletUtils가 로드되지 않음'
                    );
                    allLoaded = false;
                } else {
                    console.log('✅ WalletUtils 로드됨');
                }

                return allLoaded;
            }

            // 페이지 로드 시 자동으로 CosmosJS 상태 확인
            document.addEventListener(
                'DOMContentLoaded',
                () => {
                    console.log(
                        '=== DOMContentLoaded 이벤트 발생 ==='
                    );

                    // 즉시 초기화 확인
                    if (checkStoreInitialization()) {
                        console.log(
                            '✅ 모든 객체가 로드됨, 테스트 시작'
                        );
                        setTimeout(checkCosmosJS, 500);
                        setTimeout(testStoreState, 1000);
                    } else {
                        console.log(
                            '⚠️ 일부 객체가 로드되지 않음, 재시도 예정'
                        );
                        // 재시도 로직
                        let retryCount = 0;
                        const maxRetries = 10;

                        const retryCheck = () => {
                            retryCount++;
                            console.log(
                                `재시도 ${retryCount}/${maxRetries}`
                            );

                            if (
                                checkStoreInitialization()
                            ) {
                                console.log(
                                    '✅ 재시도 성공, 테스트 시작'
                                );
                                setTimeout(
                                    checkCosmosJS,
                                    500
                                );
                                setTimeout(
                                    testStoreState,
                                    1000
                                );
                            } else if (
                                retryCount < maxRetries
                            ) {
                                setTimeout(
                                    retryCheck,
                                    1000
                                );
                            } else {
                                console.error(
                                    '❌ 최대 재시도 횟수 초과'
                                );
                                showResult(
                                    'store-result',
                                    'Store 초기화 실패. 콘솔을 확인하세요.',
                                    true
                                );
                            }
                        };

                        setTimeout(retryCheck, 1000);
                    }
                }
            );
        </script>
    </body>
</html>
